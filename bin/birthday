#!/usr/bin/env node
const  Pool  = require('pg').Pool;
const moment = require('moment');
const { WebClient } = require('@slack/web-api');
const conversationId = 'CLSRUJMJQ';

const date = moment().format('M/DD');
const token = 'xoxb-2326495549-694802344034-FEqcSajHIlP9eYJLO5oSKX2U';
const web = new WebClient(token);


const pool = new Pool({
	user: 'llangford',
	host: 'localhost',
	database: 'testdb',
	password: '',
	port: 5432,
});



function getUserId (callback) {
	pool.query(`select email from employee where birthday_date = '${date}'`, (err, res) => {
		const emails = Object.values(res)[3];

		let emailList = emails.map(x => Object.values(x).pop());

		const userId = [];
		var itemsProcessed = 0;

		emailList.forEach((name) => {
			let trim = name.trim();
			(async () => {
				const res = await web.users.lookupByEmail({token: token, email: trim});
				const id = (Object.values(Object.values(res)[1])[0]);
				userId.push('<@' + id + '>');
				itemsProcessed++;
				if (itemsProcessed === (emailList.length)){
					callback(userId);
				}
			})();
		});
	});
}

function postMessage(userId) {
	(async () => {
		// See: https://api.slack.com/methods/chat.postMessage

		const bdayMessageArray = ['Think of it this way: You have just moved one year closer to your retirement!','Did you know my favorite coworker is having a birthday today? Have a great one!','Getting to work with someone as super as I am should be the only birthday present you really need. Plus, this present lasts all year long. Just in case, I got you another present as well. Happy birthday!','Here is to yet another 365-day trip around the sun. I hope you enjoy the trip as much this year as you did last year!','Here is to wishing you a year more successful, happy and productive than ever before. Have a great birthdayâ€”you deserve it!','Wishing you a great birthday and a memorable year!','Wishing you greatest birthday ever!','I wish you enjoy your special day. You deserve it!',];
		const res = await web.chat.postMessage({
												   channel: conversationId,
												   text: bdayMessageArray[Math.floor(Math.random() * bdayMessageArray.length)] + userId.toString(),
												   attachments: [{"image_url": "https://i.imgur.com/qs8zp4j.gif"}]
											   });

		// `res` contains information about the posted message
		// console.log('Message sent: ', res);

	})();
}

getUserId(postMessage);

pool.query(`select email from employee where to_char(anniversary_date,'FMMM/FMDD') = '${date}' `,(err,res) =>{
	const names = Object.values(Object.values(res)[3][0]);
	console.log(names);
	pool.end();
});